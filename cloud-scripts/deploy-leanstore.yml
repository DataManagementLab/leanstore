---
- name: Install LeanStore
  hosts: client-0
  connection: ssh
  become: yes
  vars:
    leanstore_dir: /opt/leanstore
    leanstore_zip_url: https://github.com/DataManagementLab/leanstore/archive/refs/heads/bookkeeper-integration.zip
  tasks:
    - name: Ensure required packages are installed on the remote host
      apt:
        name: 
          - cmake
          - libtbb2-dev
          - libaio-dev
          - libsnappy-dev
          - zlib1g-dev
          - libbz2-dev
          - liblz4-dev
          - libzstd-dev
          - librocksdb-dev
          - liblmdb-dev
          - libwiredtiger-dev
          - liburing-dev
          - openjdk-17-jdk
          - maven
          - clang-14
          - unzip
        state: present
        update_cache: yes

    - name: Remove existing LeanStore installation
      ansible.builtin.file:
        path: "{{ leanstore_dir }}"
        state: absent

    - name: Download and extract LeanStore
      unarchive:
        src: "{{ leanstore_zip_url }}"
        remote_src: yes
        dest: "/opt"
        creates: "{{ leanstore_dir }}"
     
    - name: Rename extracted directory
      command: mv /opt/leanstore-bookkeeper-integration {{ leanstore_dir }}
      args:
        creates: "{{ leanstore_dir }}"

    - name: Set correct permissions on transferred files
      file:
        path: "{{ leanstore_dir }}"
        mode: u+rwX,g+rX,o+rX
        recurse: yes

    - name: Compile Java wrapper and LeanStore
      shell: |
        cd {{ leanstore_dir }}/bookkeeper-helper && mvn package
        cd {{ leanstore_dir }} && mkdir -p build && cd build
        cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
        make tpcc
      environment:
        JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
        CXX: clang++-14

    - name: Set execute permissions for tpcc binary
      file:
        path: "{{ leanstore_dir }}/build/frontend/tpcc"
        mode: u+x,g+x,o+x
    